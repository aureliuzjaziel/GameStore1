<div class="products-container">
  <!-- Mensajes de √©xito/error -->
  <div *ngIf="successMessage" class="message success-message">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="message error-message">
    {{ errorMessage }}
  </div>

  <!-- Panel de Administraci√≥n -->
  <section *ngIf="isAdmin" class="admin-panel">
    <div class="admin-header">
      <h2>üîß Panel de Administraci√≥n</h2>
      <button class="btn-primary" (click)="mostrarFormularioProducto()">
        ‚ûï Nuevo Producto
      </button>
    </div>
  </section>

  <!-- Formulario de Producto (Modal) -->
  <div *ngIf="showProductForm" class="modal-overlay">
    <div class="modal-content">
      <form #productoForm="ngForm" (ngSubmit)="guardarProducto(productoForm)">
        <div class="modal-header">
          <h3>{{ editingProduct ? 'Editar Producto' : 'Nuevo Producto' }}</h3>
          <button type="button" class="close-btn" (click)="ocultarFormularioProducto()">‚úï</button>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label for="nombre">Nombre del Juego</label>
            <input 
              type="text" 
              id="nombre"
              name="nombre"
              [(ngModel)]="nuevoProducto.nombre"
              #nombre="ngModel"
              required
              class="form-input"
              placeholder="Nombre del juego"
            >
            <div *ngIf="nombre.invalid && nombre.touched" class="error-text">
              El nombre es requerido
            </div>
          </div>

          <div class="form-group">
            <label for="precio">Precio ($)</label>
            <input 
              type="number" 
              id="precio"
              name="precio"
              [(ngModel)]="nuevoProducto.precio"
              #precio="ngModel"
              required
              min="0"
              step="0.01"
              class="form-input"
              placeholder="0.00"
            >
            <div *ngIf="precio.invalid && precio.touched" class="error-text">
              El precio es requerido y debe ser mayor a 0
            </div>
          </div>

          <div class="form-group">
            <label for="categoria">Categor√≠a</label>
            <select 
              id="categoria"
              name="categoria"
              [(ngModel)]="nuevoProducto.categoria.id"
              #categoria="ngModel"
              required
              class="form-input"
            >
              <option value="">Seleccionar categor√≠a</option>
              <option *ngFor="let cat of categorias" [value]="cat.id">
                {{ cat.nombre | titlecase }}
              </option>
            </select>
            <div *ngIf="categoria.invalid && categoria.touched" class="error-text">
              La categor√≠a es requerida
            </div>
          </div>

          <div class="form-group">
            <label for="stock">Stock Disponible</label>
            <input 
              type="number" 
              id="stock"
              name="stock"
              [(ngModel)]="nuevoProducto.stock"
              #stock="ngModel"
              required
              min="0"
              class="form-input"
              placeholder="0"
            >
            <div *ngIf="stock.invalid && stock.touched" class="error-text">
              El stock es requerido
            </div>
          </div>

          <div class="form-group">
            <label for="desarrollador">Desarrollador</label>
            <input 
              type="text" 
              id="desarrollador"
              name="desarrollador"
              [(ngModel)]="nuevoProducto.desarrollador"
              #desarrollador="ngModel"
              required
              class="form-input"
              placeholder="Nombre del desarrollador"
            >
            <div *ngIf="desarrollador.invalid && desarrollador.touched" class="error-text">
              El desarrollador es requerido
            </div>
          </div>

          <div class="form-group">
            <label for="plataforma">Plataforma</label>
            <input 
              type="text" 
              id="plataforma"
              name="plataforma"
              [(ngModel)]="nuevoProducto.plataforma"
              #plataforma="ngModel"
              required
              class="form-input"
              placeholder="PC, PS5, Xbox, Mobile..."
            >
            <div *ngIf="plataforma.invalid && plataforma.touched" class="error-text">
              La plataforma es requerida
            </div>
          </div>

          <div class="form-group full-width">
            <label for="descripcion">Descripci√≥n del Juego</label>
            <textarea 
              id="descripcion"
              name="descripcion"
              [(ngModel)]="nuevoProducto.descripcion"
              #descripcion="ngModel"
              required
              class="form-input"
              rows="4"
              placeholder="Describe las caracter√≠sticas principales del juego..."
            ></textarea>
            <div *ngIf="descripcion.invalid && descripcion.touched" class="error-text">
              La descripci√≥n es requerida
            </div>
          </div>

          <div class="form-group full-width">
            <label for="imagen">Imagen del Juego</label>
            <div class="file-upload-container">
              <input 
                type="file" 
                id="imagen"
                name="imagen"
                (change)="onFileSelected($event)"
                accept="image/*"
                class="file-input"
                #fileInput
              >
              <button type="button" class="file-button" (click)="fileInput.click()">
                üìÅ Seleccionar Imagen
              </button>
              
              <!-- Previsualizaci√≥n de imagen -->
              <div *ngIf="imagePreview" class="image-preview-container">
                <img [src]="imagePreview" alt="Previsualizaci√≥n" class="image-preview">
                <button type="button" class="remove-image-btn" (click)="removeImage()">‚ùå</button>
              </div>
              
              <!-- Informaci√≥n del archivo -->
              <div *ngIf="selectedFile" class="file-info">
                <span>üìé {{ selectedFile.name }}</span>
                <span class="file-size">({{ (selectedFile.size / 1024 / 1024).toFixed(2) }} MB)</span>
              </div>
            </div>
            <small class="help-text">Formatos permitidos: JPG, PNG, GIF. Tama√±o m√°ximo: 5MB</small>
          </div>
        </div>

        <div class="modal-footer">
          <button 
            type="button" 
            class="btn-secondary" 
            (click)="ocultarFormularioProducto()"
            [disabled]="isSubmitting"
          >
            Cancelar
          </button>
          <button 
            type="submit" 
            class="btn-primary"
            [disabled]="!productoForm.valid || isSubmitting"
          >
            <span *ngIf="isSubmitting">Guardando...</span>
            <span *ngIf="!isSubmitting">{{ editingProduct ? 'Actualizar' : 'Crear' }}</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Header Section -->
  <section class="products-header">
    <div class="header-content">
      <h1 class="page-title">
        <span class="title-icon">üéÆ</span>
        Cat√°logo de Juegos
      </h1>
      <p class="page-subtitle">Descubre nuestra colecci√≥n completa de videojuegos</p>
    </div>
  </section>

  <!-- Filters and Search Section -->
  <section class="filters-section">
    <div class="filters-container">
      <!-- Search Bar -->
      <div class="search-area">
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Buscar juegos..." 
            class="search-input"
            [(ngModel)]="searchTerm"
            (input)="onSearchChange()"
          >
          <button class="search-btn">üîç</button>
        </div>
      </div>

      <!-- Category Filters -->
      <div class="category-filters">
        <button 
          class="filter-btn" 
          [class.active]="selectedCategory === 'all'"
          (click)="filterByCategory('all')"
        >
          Todos
        </button>
        <button 
          *ngFor="let categoria of categorias"
          class="filter-btn" 
          [class.active]="selectedCategory === categoria.nombre"
          (click)="filterByCategory(categoria.nombre)"
        >
          {{ categoria.nombre | titlecase }}
        </button>
      </div>

      <!-- Sort Options -->
      <div class="sort-options">
        <select class="sort-select" [(ngModel)]="sortBy">
          <option value="name">Ordenar por Nombre</option>
          <option value="price-low">Precio: Menor a Mayor</option>
          <option value="price-high">Precio: Mayor a Menor</option>
          <option value="rating">Mejor Valorados</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Products Grid -->
  <section class="products-grid-section">
    <!-- Mensaje si no hay productos -->
    <div *ngIf="productosFiltrados.length === 0" class="no-products-message">
      <h3>üîç No se encontraron productos</h3>
      <p>Intenta con otros t√©rminos de b√∫squeda o categor√≠a</p>
    </div>

    <!-- Grid de productos din√°mico -->
    <div class="products-grid" *ngIf="productosFiltrados.length > 0">
      <div class="product-card" *ngFor="let producto of productosFiltrados">
        <!-- Botones de administraci√≥n -->
        <div *ngIf="isAdmin" class="admin-product-actions">
          <button 
            class="btn-edit" 
            (click)="editarProducto(producto)"
            title="Editar producto"
          >
            ‚úèÔ∏è
          </button>
          <button 
            class="btn-delete" 
            (click)="eliminarProducto(producto.id)"
            title="Eliminar producto"
          >
            üóëÔ∏è
          </button>
        </div>

        <div class="product-image">
          <div class="image-placeholder" *ngIf="!producto.imagen">üéÆ</div>
          <img *ngIf="producto.imagen" 
               [src]="getImageUrl(producto.imagen)" 
               [alt]="producto.nombre || producto.title" 
               class="product-img"
               (load)="onImageLoad(producto.imagen)"
               (error)="onImageError(producto.imagen, $event)"
               loading="lazy"
               [style.display]="producto.imageError ? 'none' : 'block'">
          <div *ngIf="producto.imagen && producto.imageError" class="product-img-error">
            üñºÔ∏è Error
          </div>
          
          <!-- Badges din√°micos -->
          <div class="product-badges">
            <span *ngIf="producto.precio === 0" class="free-badge">GRATIS</span>
            <span *ngIf="producto.descuento" class="discount-badge">-{{producto.descuento}}%</span>
            <span *ngIf="!producto.activo" class="inactive-badge">INACTIVO</span>
            <span *ngIf="producto.stock === 0" class="stock-badge">SIN STOCK</span>
          </div>
          
          <div class="product-overlay">
            <button class="quick-view-btn">üëÅÔ∏è Vista R√°pida</button>
          </div>
        </div>
        
        <div class="product-info">
          <h3 class="product-title">{{ producto.nombre }}</h3>
          <p class="product-category">{{ producto.categoria?.nombre | titlecase }}</p>
          <p class="product-developer" *ngIf="producto.desarrollador">
            <span class="label">üéÆ Desarrollador:</span> {{ producto.desarrollador }}
          </p>
          <p class="product-platform" *ngIf="producto.plataforma">
            <span class="label">üì± Plataforma:</span> {{ producto.plataforma }}
          </p>
          
          <div class="product-price">
            <span *ngIf="producto.precio === 0" class="price-free">GRATIS</span>
            <span *ngIf="producto.precio > 0" class="price-current">${{ producto.precio | number:'1.2-2' }}</span>
          </div>
          
          <div class="product-stock">
            <span [class]="producto.stock > 0 ? 'stock-available' : 'stock-unavailable'">
              {{ producto.stock > 0 ? 'Stock: ' + producto.stock : 'Sin stock' }}
            </span>
          </div>
          
          <div class="product-actions">
            <button 
              class="btn-add-cart"
              [disabled]="producto.stock === 0"
              [class.disabled]="producto.stock === 0"
            >
              <span *ngIf="producto.precio === 0">üì• Descargar Gratis</span>
              <span *ngIf="producto.precio > 0 && producto.stock > 0">üõí Agregar al Carrito</span>
              <span *ngIf="producto.stock === 0">‚ùå Sin Stock</span>
            </button>
            <button class="btn-wishlist">‚ù§Ô∏è</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Pagination -->
  <section class="pagination-section" *ngIf="productosFiltrados.length > 0">
    <div class="pagination">
      <button class="page-btn prev-btn">‚óÄ Anterior</button>
      <button class="page-btn active">1</button>
      <button class="page-btn">2</button>
      <button class="page-btn">3</button>
      <button class="page-btn">4</button>
      <button class="page-btn next-btn">Siguiente ‚ñ∂</button>
    </div>
  </section>
</div>
